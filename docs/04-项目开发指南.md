# 企业ERP管理系统 - 项目开发指南

## 文档信息

| 项目名称 | 企业ERP管理系统 |
|---------|----------------|
| 文档版本 | v1.0 |
| 编写日期 | 2025-10-19 |

---

## 目录

1. [快速开始](#1-快速开始)
2. [项目结构](#2-项目结构)
3. [开发规范](#3-开发规范)
4. [后端开发指南](#4-后端开发指南)
5. [前端开发指南](#5-前端开发指南)
6. [测试指南](#6-测试指南)
7. [部署指南](#7-部署指南)
8. [常见问题](#8-常见问题)

---

## 1. 快速开始

### 1.1 环境要求

**后端环境**：
- Python 3.11+
- MySQL 8.0+
- Redis 6.0+

**前端环境**：
- Node.js 16+
- npm 或 yarn

### 1.2 克隆项目

```bash
git clone <项目地址>
cd enterprise-erp
```

### 1.3 后端启动

```bash
# 进入后端目录
cd backend

# 创建虚拟环境（如果没有）
python -m venv venv

# 激活虚拟环境
# Windows
venv\Scripts\activate
# Linux/Mac
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt

# 配置环境变量
# 复制.env.example为.env并修改配置
cp .env.example .env

# 执行数据库迁移
python manage.py migrate

# 创建超级管理员
python manage.py createsuperuser

# 启动开发服务器
python manage.py runserver
```

访问：http://localhost:8000

### 1.4 前端启动

```bash
# 进入前端目录
cd frontend

# 安装依赖
npm install

# 启动开发服务器
npm run dev
```

访问：http://localhost:5173

---

## 2. 项目结构

### 2.1 后端项目结构

```
backend/
├── erp_system/          # Django项目配置目录
│   ├── settings.py      # 配置文件
│   ├── urls.py          # 主路由
│   └── wsgi.py          # WSGI配置
├── foundation/          # 基础数据模块
│   ├── models.py        # 数据模型
│   ├── views.py         # 视图
│   ├── serializers.py   # 序列化器
│   ├── urls.py          # 路由
│   └── admin.py         # 后台管理
├── inventory/           # 库存管理模块
├── sales/               # 销售管理模块
├── procurement/         # 采购管理模块
├── production/          # 生产管理模块
├── finance/             # 财务管理模块
├── hrm/                 # 人力资源模块
├── logistics/           # 物流管理模块
├── reports/             # 报表中心模块
├── static/              # 静态文件目录
├── media/               # 媒体文件目录
├── logs/                # 日志目录
├── manage.py            # Django管理脚本
├── requirements.txt     # 依赖列表
└── .env                 # 环境变量配置
```

### 2.2 前端项目结构

```
frontend/
├── public/              # 公共静态资源
├── src/
│   ├── api/             # API接口封装
│   │   ├── auth.js      # 认证接口
│   │   ├── foundation.js # 基础数据接口
│   │   └── ...
│   ├── assets/          # 静态资源
│   │   ├── icons/       # 图标
│   │   └── images/      # 图片
│   ├── components/      # 全局组件
│   ├── layouts/         # 布局组件
│   │   └── MainLayout.vue
│   ├── router/          # 路由配置
│   │   └── index.js
│   ├── store/           # Pinia状态管理
│   │   ├── index.js
│   │   ├── user.js
│   │   └── app.js
│   ├── styles/          # 全局样式
│   │   ├── variables.scss
│   │   └── mixins.scss
│   ├── utils/           # 工具函数
│   │   ├── request.js   # 请求封装
│   │   └── auth.js      # 认证工具
│   ├── views/           # 页面组件
│   │   ├── login/       # 登录页
│   │   ├── dashboard/   # 工作台
│   │   ├── foundation/  # 基础数据
│   │   ├── inventory/   # 库存管理
│   │   └── ...
│   ├── App.vue          # 根组件
│   └── main.js          # 入口文件
├── .env.development     # 开发环境配置
├── .env.production      # 生产环境配置
├── vite.config.js       # Vite配置
└── package.json         # 依赖配置
```

---

## 3. 开发规范

### 3.1 代码规范

**Python代码规范**：
- 遵循PEP8规范
- 使用Black格式化工具
- 使用Flake8进行代码检查
- 类名使用大驼峰（ClassName）
- 函数名使用下划线（function_name）
- 常量使用全大写（CONSTANT_NAME）

**JavaScript代码规范**：
- 遵循ESLint规范
- 使用Prettier格式化工具
- 变量名使用小驼峰（variableName）
- 常量使用全大写（CONSTANT_NAME）
- 组件名使用大驼峰（ComponentName）

### 3.2 Git提交规范

```
<type>(<scope>): <subject>

<body>

<footer>
```

**Type类型**：
- `feat`: 新功能
- `fix`: 修复Bug
- `docs`: 文档更新
- `style`: 代码格式调整
- `refactor`: 重构代码
- `test`: 测试相关
- `chore`: 构建/工具相关

**示例**：
```
feat(foundation): 添加部门管理功能

- 实现部门的增删改查
- 添加部门树形结构展示
- 支持部门数据导出

Closes #123
```

### 3.3 分支管理

- `main`: 主分支，生产环境代码
- `develop`: 开发分支
- `feature/xxx`: 功能分支
- `hotfix/xxx`: 紧急修复分支
- `release/xxx`: 发布分支

**工作流程**：
1. 从develop创建feature分支
2. 在feature分支开发功能
3. 开发完成后合并到develop
4. 测试通过后从develop创建release分支
5. release测试通过后合并到main并打tag

---

## 4. 后端开发指南

### 4.1 创建新模块

#### 4.1.1 创建应用

```bash
python manage.py startapp module_name
```

#### 4.1.2 注册应用

在`settings.py`中添加：

```python
INSTALLED_APPS = [
    # ...
    'module_name',
]
```

### 4.2 数据模型开发

#### 4.2.1 定义Model

```python
# foundation/models.py
from django.db import models
from django.contrib.auth.models import AbstractUser

class BaseModel(models.Model):
    """基础模型"""
    created_at = models.DateTimeField(auto_now_add=True, verbose_name='创建时间')
    updated_at = models.DateTimeField(auto_now=True, verbose_name='更新时间')
    created_by = models.ForeignKey('User', on_delete=models.SET_NULL,
                                   null=True, related_name='+', verbose_name='创建人')
    updated_by = models.ForeignKey('User', on_delete=models.SET_NULL,
                                   null=True, related_name='+', verbose_name='更新人')
    is_deleted = models.BooleanField(default=False, verbose_name='是否删除')
    remark = models.CharField(max_length=500, blank=True, verbose_name='备注')

    class Meta:
        abstract = True


class Department(BaseModel):
    """部门表"""
    parent = models.ForeignKey('self', on_delete=models.CASCADE,
                              null=True, blank=True, related_name='children',
                              verbose_name='父部门')
    dept_code = models.CharField(max_length=50, unique=True, verbose_name='部门编码')
    dept_name = models.CharField(max_length=100, verbose_name='部门名称')
    dept_type = models.SmallIntegerField(choices=[(1, '公司'), (2, '部门'), (3, '小组')],
                                        default=2, verbose_name='部门类型')
    leader = models.ForeignKey('User', on_delete=models.SET_NULL,
                              null=True, blank=True, related_name='led_departments',
                              verbose_name='负责人')
    phone = models.CharField(max_length=20, blank=True, verbose_name='联系电话')
    email = models.EmailField(blank=True, verbose_name='邮箱')
    sort_order = models.IntegerField(default=0, verbose_name='显示顺序')
    status = models.SmallIntegerField(choices=[(1, '正常'), (0, '停用')],
                                     default=1, verbose_name='状态')

    class Meta:
        db_table = 'foundation_department'
        verbose_name = '部门'
        verbose_name_plural = verbose_name
        ordering = ['sort_order', 'dept_code']

    def __str__(self):
        return self.dept_name
```

#### 4.2.2 创建迁移文件

```bash
python manage.py makemigrations
python manage.py migrate
```

### 4.3 序列化器开发

```python
# foundation/serializers.py
from rest_framework import serializers
from .models import Department

class DepartmentSerializer(serializers.ModelSerializer):
    """部门序列化器"""
    parent_name = serializers.CharField(source='parent.dept_name', read_only=True)
    leader_name = serializers.CharField(source='leader.real_name', read_only=True)

    class Meta:
        model = Department
        fields = '__all__'
        read_only_fields = ['id', 'created_at', 'updated_at']

    def validate_dept_code(self, value):
        """验证部门编码唯一性"""
        instance = self.instance
        if instance:
            # 更新时排除自身
            if Department.objects.filter(dept_code=value).exclude(id=instance.id).exists():
                raise serializers.ValidationError('部门编码已存在')
        else:
            # 新建时直接检查
            if Department.objects.filter(dept_code=value).exists():
                raise serializers.ValidationError('部门编码已存在')
        return value


class DepartmentTreeSerializer(serializers.ModelSerializer):
    """部门树序列化器"""
    children = serializers.SerializerMethodField()

    class Meta:
        model = Department
        fields = ['id', 'dept_code', 'dept_name', 'parent_id', 'children']

    def get_children(self, obj):
        if obj.children.exists():
            return DepartmentTreeSerializer(obj.children.filter(is_deleted=False), many=True).data
        return []
```

### 4.4 视图开发

```python
# foundation/views.py
from rest_framework import viewsets, status
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated
from django_filters.rest_framework import DjangoFilterBackend
from rest_framework.filters import SearchFilter, OrderingFilter
from .models import Department
from .serializers import DepartmentSerializer, DepartmentTreeSerializer

class DepartmentViewSet(viewsets.ModelViewSet):
    """部门视图集"""
    queryset = Department.objects.filter(is_deleted=False)
    serializer_class = DepartmentSerializer
    permission_classes = [IsAuthenticated]
    filter_backends = [DjangoFilterBackend, SearchFilter, OrderingFilter]
    filterset_fields = ['dept_type', 'status', 'parent']
    search_fields = ['dept_code', 'dept_name']
    ordering_fields = ['sort_order', 'created_at']
    ordering = ['sort_order']

    def perform_create(self, serializer):
        """创建时自动设置创建人"""
        serializer.save(created_by=self.request.user)

    def perform_update(self, serializer):
        """更新时自动设置更新人"""
        serializer.save(updated_by=self.request.user)

    def perform_destroy(self, instance):
        """软删除"""
        instance.is_deleted = True
        instance.save()

    @action(detail=False, methods=['get'])
    def tree(self, request):
        """获取部门树"""
        # 只获取顶级部门（parent为空）
        queryset = self.queryset.filter(parent__isnull=True)
        serializer = DepartmentTreeSerializer(queryset, many=True)
        return Response({
            'code': 200,
            'message': 'success',
            'data': serializer.data
        })
```

### 4.5 路由配置

```python
# foundation/urls.py
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from . import views

router = DefaultRouter()
router.register('departments', views.DepartmentViewSet, basename='department')

urlpatterns = [
    path('', include(router.urls)),
]

# erp_system/urls.py
from django.contrib import admin
from django.urls import path, include

urlpatterns = [
    path('admin/', admin.site.urls),
    path('api/v1/foundation/', include('foundation.urls')),
    path('api/v1/inventory/', include('inventory.urls')),
    # ...
]
```

### 4.6 权限控制

```python
# foundation/permissions.py
from rest_framework import permissions

class IsAdminOrReadOnly(permissions.BasePermission):
    """只有管理员可以修改，其他用户只读"""

    def has_permission(self, request, view):
        if request.method in permissions.SAFE_METHODS:
            return True
        return request.user and request.user.is_staff

class HasDepartmentPermission(permissions.BasePermission):
    """检查用户是否有部门权限"""

    def has_permission(self, request, view):
        # 检查用户权限
        return request.user.has_perm('foundation.view_department')

    def has_object_permission(self, request, view, obj):
        # 检查对象级权限
        if request.user.is_staff:
            return True
        # 只能操作自己部门的数据
        return obj.dept == request.user.dept
```

---

## 5. 前端开发指南

### 5.1 创建新页面

#### 5.1.1 创建页面组件

```vue
<!-- src/views/foundation/department/index.vue -->
<template>
  <div class="department-container">
    <el-card>
      <!-- 搜索区域 -->
      <el-form :inline="true" :model="queryForm">
        <el-form-item label="部门名称">
          <el-input v-model="queryForm.dept_name" placeholder="请输入部门名称" clearable />
        </el-form-item>
        <el-form-item>
          <el-button type="primary" @click="handleQuery">查询</el-button>
          <el-button @click="handleReset">重置</el-button>
          <el-button type="success" @click="handleAdd">新增</el-button>
        </el-form-item>
      </el-form>

      <!-- 表格区域 -->
      <el-table :data="tableData" border stripe>
        <el-table-column prop="dept_code" label="部门编码" width="150" />
        <el-table-column prop="dept_name" label="部门名称" />
        <el-table-column prop="parent_name" label="上级部门" />
        <el-table-column prop="leader_name" label="负责人" width="120" />
        <el-table-column prop="phone" label="联系电话" width="130" />
        <el-table-column label="状态" width="80">
          <template #default="{ row }">
            <el-tag :type="row.status === 1 ? 'success' : 'danger'">
              {{ row.status === 1 ? '正常' : '停用' }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column label="操作" width="200" fixed="right">
          <template #default="{ row }">
            <el-button type="primary" size="small" @click="handleEdit(row)">编辑</el-button>
            <el-button type="danger" size="small" @click="handleDelete(row)">删除</el-button>
          </template>
        </el-table-column>
      </el-table>

      <!-- 分页 -->
      <el-pagination
        v-model:current-page="queryForm.page"
        v-model:page-size="queryForm.page_size"
        :total="total"
        layout="total, sizes, prev, pager, next, jumper"
        @size-change="handleQuery"
        @current-change="handleQuery"
      />
    </el-card>

    <!-- 新增/编辑对话框 -->
    <el-dialog v-model="dialogVisible" :title="dialogTitle" width="600px">
      <el-form ref="formRef" :model="form" :rules="rules" label-width="100px">
        <el-form-item label="部门编码" prop="dept_code">
          <el-input v-model="form.dept_code" placeholder="请输入部门编码" />
        </el-form-item>
        <el-form-item label="部门名称" prop="dept_name">
          <el-input v-model="form.dept_name" placeholder="请输入部门名称" />
        </el-form-item>
        <!-- 更多字段... -->
      </el-form>
      <template #footer>
        <el-button @click="dialogVisible = false">取消</el-button>
        <el-button type="primary" @click="handleSubmit">确定</el-button>
      </template>
    </el-dialog>
  </div>
</template>

<script setup>
import { ref, reactive, onMounted } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import { getDepartmentList, createDepartment, updateDepartment, deleteDepartment } from '@/api/foundation'

// 响应式数据
const tableData = ref([])
const total = ref(0)
const dialogVisible = ref(false)
const dialogTitle = ref('新增部门')
const formRef = ref(null)

// 查询表单
const queryForm = reactive({
  dept_name: '',
  page: 1,
  page_size: 20
})

// 表单数据
const form = reactive({
  dept_code: '',
  dept_name: '',
  parent_id: null,
  status: 1
})

// 表单验证规则
const rules = {
  dept_code: [
    { required: true, message: '请输入部门编码', trigger: 'blur' }
  ],
  dept_name: [
    { required: true, message: '请输入部门名称', trigger: 'blur' }
  ]
}

// 获取列表数据
const getList = async () => {
  try {
    const res = await getDepartmentList(queryForm)
    tableData.value = res.data.results
    total.value = res.data.count
  } catch (error) {
    ElMessage.error('获取数据失败')
  }
}

// 查询
const handleQuery = () => {
  queryForm.page = 1
  getList()
}

// 重置
const handleReset = () => {
  Object.assign(queryForm, {
    dept_name: '',
    page: 1,
    page_size: 20
  })
  getList()
}

// 新增
const handleAdd = () => {
  dialogTitle.value = '新增部门'
  Object.assign(form, {
    dept_code: '',
    dept_name: '',
    parent_id: null,
    status: 1
  })
  dialogVisible.value = true
}

// 编辑
const handleEdit = (row) => {
  dialogTitle.value = '编辑部门'
  Object.assign(form, row)
  dialogVisible.value = true
}

// 提交
const handleSubmit = async () => {
  await formRef.value.validate()
  try {
    if (form.id) {
      await updateDepartment(form.id, form)
      ElMessage.success('更新成功')
    } else {
      await createDepartment(form)
      ElMessage.success('创建成功')
    }
    dialogVisible.value = false
    getList()
  } catch (error) {
    ElMessage.error(error.message || '操作失败')
  }
}

// 删除
const handleDelete = (row) => {
  ElMessageBox.confirm(`确定要删除部门"${row.dept_name}"吗？`, '提示', {
    type: 'warning'
  }).then(async () => {
    try {
      await deleteDepartment(row.id)
      ElMessage.success('删除成功')
      getList()
    } catch (error) {
      ElMessage.error('删除失败')
    }
  }).catch(() => {})
}

// 初始化
onMounted(() => {
  getList()
})
</script>

<style scoped lang="scss">
.department-container {
  padding: 20px;
}
</style>
```

#### 5.1.2 创建API接口

```javascript
// src/api/foundation.js
import request from '@/utils/request'

/**
 * 获取部门列表
 */
export const getDepartmentList = (params) => {
  return request.get('/api/v1/foundation/departments/', { params })
}

/**
 * 获取部门详情
 */
export const getDepartmentDetail = (id) => {
  return request.get(`/api/v1/foundation/departments/${id}/`)
}

/**
 * 创建部门
 */
export const createDepartment = (data) => {
  return request.post('/api/v1/foundation/departments/', data)
}

/**
 * 更新部门
 */
export const updateDepartment = (id, data) => {
  return request.put(`/api/v1/foundation/departments/${id}/`, data)
}

/**
 * 删除部门
 */
export const deleteDepartment = (id) => {
  return request.delete(`/api/v1/foundation/departments/${id}/`)
}

/**
 * 获取部门树
 */
export const getDepartmentTree = () => {
  return request.get('/api/v1/foundation/departments/tree/')
}
```

#### 5.1.3 配置路由

```javascript
// src/router/index.js
const routes = [
  // ...
  {
    path: '/',
    component: () => import('@/layouts/MainLayout.vue'),
    redirect: '/dashboard',
    meta: { requiresAuth: true },
    children: [
      {
        path: 'foundation',
        meta: { title: '基础数据', icon: 'Setting' },
        children: [
          {
            path: 'department',
            name: 'Department',
            component: () => import('@/views/foundation/department/index.vue'),
            meta: { title: '部门管理', icon: 'OfficeBuilding' }
          }
        ]
      }
    ]
  }
]
```

### 5.2 全局组件封装

```vue
<!-- src/components/TablePagination.vue -->
<template>
  <el-pagination
    v-model:current-page="currentPage"
    v-model:page-size="pageSize"
    :page-sizes="[10, 20, 50, 100]"
    :total="total"
    layout="total, sizes, prev, pager, next, jumper"
    @size-change="handleSizeChange"
    @current-change="handleCurrentChange"
  />
</template>

<script setup>
import { computed } from 'vue'

const props = defineProps({
  total: {
    type: Number,
    required: true
  },
  page: {
    type: Number,
    default: 1
  },
  pageSize: {
    type: Number,
    default: 20
  }
})

const emit = defineEmits(['update:page', 'update:pageSize', 'change'])

const currentPage = computed({
  get: () => props.page,
  set: (val) => emit('update:page', val)
})

const pageSize = computed({
  get: () => props.pageSize,
  set: (val) => emit('update:pageSize', val)
})

const handleSizeChange = () => {
  emit('change')
}

const handleCurrentChange = () => {
  emit('change')
}
</script>
```

---

## 6. 测试指南

### 6.1 后端单元测试

```python
# foundation/tests.py
from django.test import TestCase
from django.contrib.auth import get_user_model
from .models import Department

User = get_user_model()

class DepartmentTestCase(TestCase):
    def setUp(self):
        """测试前准备"""
        self.user = User.objects.create_user(
            username='test',
            password='test123'
        )

    def test_create_department(self):
        """测试创建部门"""
        dept = Department.objects.create(
            dept_code='D001',
            dept_name='技术部',
            created_by=self.user
        )
        self.assertEqual(dept.dept_name, '技术部')

    def test_department_str(self):
        """测试部门字符串表示"""
        dept = Department.objects.create(
            dept_code='D001',
            dept_name='技术部'
        )
        self.assertEqual(str(dept), '技术部')
```

运行测试：
```bash
python manage.py test
```

### 6.2 API测试

```python
# foundation/tests/test_api.py
from rest_framework.test import APITestCase
from rest_framework import status
from django.contrib.auth import get_user_model
from foundation.models import Department

User = get_user_model()

class DepartmentAPITestCase(APITestCase):
    def setUp(self):
        self.user = User.objects.create_user(
            username='test',
            password='test123'
        )
        self.client.force_authenticate(user=self.user)

    def test_list_departments(self):
        """测试获取部门列表"""
        Department.objects.create(dept_code='D001', dept_name='技术部')
        response = self.client.get('/api/v1/foundation/departments/')
        self.assertEqual(response.status_code, status.HTTP_200_OK)

    def test_create_department(self):
        """测试创建部门"""
        data = {
            'dept_code': 'D001',
            'dept_name': '技术部',
            'status': 1
        }
        response = self.client.post('/api/v1/foundation/departments/', data)
        self.assertEqual(response.status_code, status.HTTP_201_CREATED)
```

---

## 7. 部署指南

### 7.1 生产环境配置

#### 7.1.1 后端配置

```python
# settings.py
DEBUG = False
ALLOWED_HOSTS = ['yourdomain.com', 'www.yourdomain.com']

# 静态文件
STATIC_ROOT = BASE_DIR / 'staticfiles'

# 数据库（使用连接池）
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': 'erp_system',
        'USER': 'your_user',
        'PASSWORD': 'your_password',
        'HOST': 'localhost',
        'PORT': '3306',
        'OPTIONS': {
            'charset': 'utf8mb4',
            'init_command': "SET sql_mode='STRICT_TRANS_TABLES'",
        },
        'CONN_MAX_AGE': 600,  # 连接池
    }
}
```

#### 7.1.2 收集静态文件

```bash
python manage.py collectstatic
```

#### 7.1.3 使用Gunicorn

```bash
pip install gunicorn
gunicorn erp_system.wsgi:application --bind 0.0.0.0:8000 --workers 4
```

### 7.2 Nginx配置

```nginx
server {
    listen 80;
    server_name yourdomain.com;

    # 前端静态文件
    location / {
        root /var/www/frontend/dist;
        try_files $uri $uri/ /index.html;
    }

    # 后端API
    location /api/ {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # 静态文件
    location /static/ {
        alias /var/www/backend/staticfiles/;
    }

    # 媒体文件
    location /media/ {
        alias /var/www/backend/media/;
    }
}
```

---

## 8. 常见问题

### 8.1 后端常见问题

**Q: 数据库迁移失败？**
A: 检查数据库连接配置，确保数据库用户有足够权限

**Q: CORS跨域问题？**
A: 检查`settings.py`中的`CORS_ALLOWED_ORIGINS`配置

**Q: JWT Token过期？**
A: 使用refresh token刷新access token

### 8.2 前端常见问题

**Q: API请求401错误？**
A: 检查Token是否过期，是否正确添加到请求头

**Q: 路由跳转404？**
A: 检查路由配置是否正确，组件路径是否存在

**Q: Element Plus组件不显示？**
A: 检查是否正确导入Element Plus和样式文件

---

**文档结束**
